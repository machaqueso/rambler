<script src="../../lib/signalr/dist/browser/signalr.js"></script>

<link rel="import" href="../paper-toast/paper-toast.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<link rel="import" href="chat-message.html" />

<dom-module id="rambler-chat">
    <template>
        <style>
            .authorContext {
                z-index: 10;
                position: absolute;
                display: block;
                color: black;
                background-color: whitesmoke;
                list-style-type: none;
                list-style: none;
                margin: 0;
                padding: 5px;
            }

                .authorContext li:hover {
                    background-color: gainsboro;
                }
        </style>
        <iron-ajax auto id="ajax"
                   url="/api/chat?maxItems=[[maxLines]]"
                   handle-as="json"
                   loading="{{loading}}"
                   last-response="{{messages}}"></iron-ajax>

        <iron-ajax id="putAction"
                   handle-as="json"
                   content-type="application/json"
                   loading="{{loading}}"
                   method="PUT"
                   on-error="_onActionError"
                   debounce-duration="300"></iron-ajax>

        <div class="chat">
            <template is="dom-repeat" items="{{messages}}" restamp>
                <template is="dom-if" if="[[showDate]]">
                    <chat-message item="{{item}}" show-date timeout="[[timeout]]" show-speaker="[[speakEnabled]]" on-click="_onChatClick"></chat-message>
                </template>
                <template is="dom-if" if="[[!showDate]]">
                    <chat-message item="{{item}}" timeout="[[timeout]]" show-speaker="[[speakEnabled]]" on-click="_onChatClick"></chat-message>
                </template>
            </template>
        </div>
        <ul hidden$="[[hideAuthorContext]]" id="context-menu" class="authorContext">
            <template is="dom-repeat" items="[[actions]]">
                <li value="{{item}}" on-click="_authorAction">{{item}}</li>
            </template>
        </ul>
        <paper-toast id="toast"></paper-toast>
    </template>
    <script>
        HTMLImports.whenReady(function () {
            Polymer({
                is: "rambler-chat",
                properties: {
                    messages: { type: Array, notify: true, value: [] },
                    connection: { type: Object, value: {} },
                    channel: { type: String, value: "All" },
                    showDate: { type: Boolean, value: false },
                    speakEnabled: { type: Boolean, notify: true, value: false },
                    voice: { type: Object, notify: true },
                    maxLines: { type: Number, value: 10 },
                    hideAuthorContext: { type: Boolean, notify: true, value: true },
                    actions: { type: Array }
                },

                listeners: {
                    'author-click': '_onAuthorClick',
                },

                _onMessageReceived: function (message) {
                    if (!message) return;

                    console.log(message, this.maxLines);
                    this.push("messages", message);
                    if (this.messages.length > this.maxLines) {
                        this.shift("messages");
                    }
                    this.fire("messageReceived");
                },
                _speak: function (message) {
                    //console.log("speak");

                    if (message !== '') {
                        var utterThis = new SpeechSynthesisUtterance(message);
                        //utterThis.onend = function (event) {
                        //    console.log('SpeechSynthesisUtterance.onend');
                        //}
                        utterThis.onerror = function (event) {
                            console.error('SpeechSynthesisUtterance.onerror', event);
                        }

                        console.log("voice", utterThis.voice);
                        console.log("lang", utterThis.lang);
                        if (this.voice !== undefined) {
                            utterThis.voice = this.voice;
                        } else {
                            utterThis.lang = "es-ES";
                        }
                        //utterThis.pitch = this.pitch;
                        //utterThis.rate = this.rate;
                        speechSynthesis.speak(utterThis);
                    }
                },
                _getVoiceByName: function (name) {
                    var voices = [];
                    voices = window.speechSynthesis.getVoices();
                    console.log("voices", voices.length);

                    for (i = 0; i < voices.length; i++) {
                        console.log(voices[i]);
                        if (voices[i].name === name) {
                            console.log("returning voice", voices[i]);
                            return voices[i];
                        }
                    }
                },
                _onVoicesChanged: function (e, sender) {
                    console.log("_onVoicesChanged", e, sender)
                    if (speechSynthesis === undefined) {
                        return;
                    }
                    sender.voice = sender._getVoiceByName("Microsoft Helena Desktop - Spanish (Spain)");
                },
                _onChatClick: function (e) {
                    //console.log(e);
                    if (this.speakEnabled) {
                        this._speak(e.model.item.message);
                    }
                },
                _onAuthorClick: function (e) {
                    //console.log('_onAuthorClick', e.detail.author);

                    this.author = e.detail.author;

                    this.hideAuthorContext = !this.hideAuthorContext;
                    if (!this.hideAuthorContext) {
                        //console.log(e.detail.x, e.detail.y, e.target.offsetLeft, e.target.offsetTop);

                        var menu = document.querySelector("#context-menu");
                        menu.style.left = e.detail.x + "px";
                        menu.style.top = e.detail.y + "px";
                    }
                },
                _authorAction: function (e) {
                    console.log("_authorAction", e.model.item, this.author.authorId);
                    this.$.putAction.url = "/api/author/" + this.author.authorId + "/" + e.model.item;
                    this.$.putAction.generateRequest();
                    this.hideAuthorContext = true;
                },
                _onActionError: function (e) {
                    console.log(e.detail.request.xhr.response);
                },
                ready: function () {
                    var _this = this;
                    this.connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

                    this.connection.on("ReceiveChannelMessage",
                        function (message) {
                            console.log("ReceiveChannelMessage", message);
                            if (message.channel == _this.channel) {
                                _this._onMessageReceived(message.chatMessage);
                            }
                            if (_this.speakEnabled && message.channel === "TTS") {
                                _this._speak(message.chatMessage.message);
                            }
                        });

                    this.connection.start().catch(function (err) {
                        return console.error(err.toString());
                    });

                    speechSynthesis = window.speechSynthesis;
                    this._onVoicesChanged(undefined, this);
                    if (speechSynthesis.onvoiceschanged !== undefined) {
                        speechSynthesis.onvoiceschanged = function (e) {
                            return _this._onVoicesChanged(e, _this);
                        }
                    }

                    this.set("actions", ["Upvote", "Downvote", "Whitelist", "Ignore", "Blacklist", "Ban"])

                }
            });
        });
    </script>
</dom-module>
